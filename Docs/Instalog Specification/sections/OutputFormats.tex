\section{Output Formats}
This section defines various output formats that Instalog uses.  The formats
defined in this section are referred to throughout this document and therefore
have been extracted to this common section.

\subsection{Escaping Formats}
In order to meet the requirements of machine readability and human readability,
several escaping formats must be used depending on the type of data to produce
the most readable unambiguous representation given typical data collected from a
given location.

\subsubsection{General Escaping Format}
Generally, escaping MUST be done in a manner similar to most programming
languages, such as C, C++, Java, or similar, for quoted string escapes. Such an
escaping scheme is defined by three characters: an optional starting delimiter,
an optional termination delimiter, and an escape character. For instance, in C,
the starting delimiter is the quote mark, \verb|"|, the ending delimiter is also
a quote mark \verb|"|, and the escape character is the backslash \verb|\|.

For most types of information Instalog enumerates, such as Windows file paths,
the exact method C uses is unsuitable; backslashes occur far too often inside
file paths for the backslash as an escape character to make a good choice.
Legacy applications like the command processor (\texttt{cmd.exe}) get around
such problems by implementing complicated escaping schemes (defined in section
\ref{winescape} below), but these are designed with specific input data in mind
(file paths and command line switches, for instance), which is not the case for
most reported data.

\label{generalescape}
Therefore, Instalog shall use define a general escape function that works in a
manner similar to C's string literal escapes, but which allows arbitrary
termination, and escaping characters. The input to the escape function is raw
data obtained from some data source, and the output is the same data with
the following textual replacements: 

\begin{itemize}
    \item \var{EscapeCharacter} is replaced with
    \var{EscapeCharacter}\var{EscapeCharacter}.
    \item \var{RightDelimiter}, if defined,  is replaced with
    \var{EscapeCharacter}\var{RightDelimiter}.
    \item The null character (ASCII \verb|0x00|) is replaced with
    \var{EscapeCharacter}\texttt{0}.
    \item The backspace character (ASCII \verb|0x08|) is replaced with
    \var{EscapeCharacter}\texttt{b}.
    \item The form feed character (ASCII \verb|0x0C|) is replaced with
    \var{EscapeCharacter}\texttt{f}.
    \item The newline character (ASCII \verb|0x0A|) is replaced with
    \var{EscapeCharacter}\texttt{n}.
    \item The carriage return character (ASCII \verb|0x0D|) is replaced with
    \var{EscapeCharacter}\texttt{r}.
    \item The horizontal tab character (ASCII \verb|0x09|) is replaced with
    \var{EscapeCharacter}\texttt{t}.
    \item The vertical tab character (ASCII \verb|0x0B|) is replaced with
    \var{EscapeCharacter}\texttt{v}.
    \item ASCII characters which are not in the above list but are unprintable
    (that is, ASCII \verb|0x00| - \verb|0x1F|; \verb|0x7F|) are
    replaced with \var{EscapeCharacter}\texttt{xHH}, where \texttt{HH} is the
    hexadecimal representation of the numeric value of the given character.
    \item Non-ASCII characters (\verb|U+0080| and above) are replaced with
    \var{EscapeCharacter}\texttt{xHH} escape sequences, where \texttt{HH} is the
    hexadecimal represenation of the UTF-8 surrogate pairs necessary to create
    the non-ASCII character. (Example: When \var{EscapeCharacter} is \verb|#|,
    \verb|U+00A9 COPYRIGHT SYMBOL| becomes \verb|#C2#A9|, \verb|U+2014 EM DASH|
    becomes \verb|#E2#80#94|.)
    \item Forum software destroys significant whitespace; but escaping every
    space would be impractical. Where there is more than a single consecutive
    space, the second and later spaces are escaped. (That is, replaced with
    ``\var{EscapeCharacter}\texttt{ }''.) The only exception to this rule is if
    the first character in a string is a space, then it shall be escaped.  
    \item Any instance of \var{EscapeCharacter} followed by an unused character
    in the above list is equivalent to that character with no escape. This will
    never be generated by the escaping functionality in Instalog for general
    escaping, but is valid for the reverse, unescaping, operation.
\end{itemize}

\subsubsection{URL Escaping Format} \label{urlescape}
URL escaping matches the general escaping format above, except has the
additional constraint of forum software which tries to convert URLs into links.
It is desirable to inhibit this behavior of the forum software, so that board
owners need not worry about linking to malicious websites. Therefore, URL
escaping is defined to be general escaping with the additional requirement that
when the string ``\texttt{http}'' (case insensitive) appears, it is replaced
with ``\texttt{htt}\var{EscapeCharacter}\texttt{p}''. This inhibits forum
software's URL behavior which looks for the protocol prefix in order to
determine what portions of a post indicate a link. (Note that due to the last
requirement of general escaping this will cause no effect on the unescaped
data).

\subsubsection{CommandLineToArgvW Escaping Format} \label{winescape}
Windows' own \verb|CommandLineToArgvW| function defines its own escaping
scheme. This format is delimited on both the left and right by quote (\verb|"|)
characters. Instalog shall interpret this format exactly as Windows' function
does. Quoting MSDN:

\begin{quote}
\verb|CommandLineToArgvW| has a special interpretation of backslash characters
when they are followed by a quotation mark character (\verb|"|), as follows:
\begin{itemize}
    \item $2n$ backslashes followed by a quotation mark produce $n$ backslashes
    followed by a quotation mark.
    \item $(2n) + 1$ backslashes followed by a quotation mark again produce $n$
    backslashes followed by a quotation mark.
    \item $n$ backslashes not followed by a quotation mark simply produce $n$
    backslashes.
\end{itemize}
\end{quote}

\subsection{Date Formats}
Instalog shall use two date formats.

\subsubsection{Standard Date Format} \label{stddate}
The standard date format shall be defined as
\begin{verbatim}
${YYYY}-${MM}-${DD} ${HH}:${MM}:${SS}
\end{verbatim}
Where \var{YYYY} is the four digit year, \var{MM} is the two digit month,
\var{DD} is the two digit day, \var{HH} is the two digit hour, \var{MM} is the
two digit minute count, and \var{SS} is the two digit number of seconds.

If the given value is fewer than the number of digits available, they shall be
zero padded to take up as many spaces as that item has been assigned.

\subsubsection{Millisecond Date Format} \label{millidate}
The millisecond date format shall be defined as
\begin{verbatim}
${YYYY}-${MM}-${DD} ${HH}:${MM}:${SS}.${Milli}
\end{verbatim}
Where \var{YYYY} is the four digit year, \var{MM} is the two digit month,
\var{DD} is the two digit day, \var{HH} is the two digit hour, \var{MM} is the
two digit minute count, \var{SS} is the two digit number of seconds, and
\var{Milli} is the 4 digit number of milliseconds.

If the given value is fewer than the number of digits available, they shall be
zero padded to take up as many spaces as that item has been assigned.

\subsection{Path Formats}
Instalog uses several path formats across its log output.

\subsubsection{Path Resolution} \label{pathresolution}
Windows often does not provide Instalog with direct path information; providing
a full command line including arguments in some cases. Disambiguating which part
of a given command line is a path to an executable and which is part of the
arguments requires access to the filesystem of the target machine to determine.
Additionally, several APIs used by Instalog return native (NT) paths rather than
Win32 paths as a user would expect. To combat these problems, Instalog must
implement a path resolution facility.

Path resolution consists of three phases:
\begin{enumerate}
    \item Conversion from Native Path to Win32 Path
    \item Separation of the Win32 path from its arguments
    \item Removal of common path prefixes that serve as redirectors
\end{enumerate}

Instalog will use a heuristic to convert from the NT path to the Win32 path; as
there is no consistent API exposed by Windows for this task. This heuristic
consists of replacing several prefixes on the path with known values. These
replacements must be done in the following order.
\begin{enumerate}
    \item If the path begins with \verb|\|, the \verb|\| is removed.
    \item Afterwards, if the path begins with \verb|??\|, the \verb|??\| is
    removed.
    \item Afterwards, if the path begins with \verb|\?\|, then the \verb|\?\| is
    removed.
    \item Afterwards, if the path begins with \verb|globalroot\|, then
    \verb|globalroot\| is removed.
    \item Afterwards, if the path begins with \verb|system32\|, then
    \verb|system32\| is replaced with the path \verb|${WINDIR}\system32\|, where
    \var{WINDIR} is the location where Windows is installed.
    \item Finally, if the path begins with \verb|systemroot\|, then
    \verb|systemroot\| is replaced with the path to the current Windows
    installation followed by a backslash.
\end{enumerate}

After this heuristic is applied, the resulting path should correspond to a Win32
path.

The second phase consists of separation of the executable path from its
arguments. This is done in the same way that Windows' own \verb|CreateProcessW|
API call does. It is based on the current value of the environment variables
\verb|%PATH%| and \verb|%PATHEXT%|. The first defines to Windows where
executables are located, while the second defines which file extensions are
allowed to be implicitly interpreted as executables.

At first, any leading space in the path is removed. Next, if the path begins
with a quote (\verb|"|) character, then the path is treated as a quoted path
that follows the same convention that Windows' own \verb|CommandLineToArgvW|
function does (see section \ref{winescape}).

Otherwise, Instalog shall try to interpret the path in terms of the portions
that end in spaces. For instance:
\begin{verbatim}
C:\Folder with .exe in the name.exe\Program.exe ProgramThatIsAnArgument.exe
         ^    ^    ^  ^   ^                    ^
\end{verbatim}
at each space point (indicated above with \verb|^|s), Instalog checks for
information about the file. If the file does not exist, each of the extensions
in \verb|%PATHEXT%| are tried, appending them to the part of the path before the
space, one by one, until a file is found that exists. If this still does not
work, Instalog shall repeat the \verb|%PATHEXT%| part of the check, prefixing
the entire path with each of the paths in \verb|%PATH%|, until it finds a match.
If it still cannot find a matching file, Instalog moves on to the next space.

For example, if \verb|%PATH%=C:\Windows;C:\Windows\System32|, and
\verb|%PATHEXT%=.bat;.com;.exe|, and one is trying to parse a command line of
\verb|rundll32 example.dll|, Instalog shall try the following paths, in
order:
\begin{verbatim}
rundll32
rundll32.bat
rundll32.com
rundll32.exe
C:\Windows\rundll32
C:\Windows\rundll32.bat
C:\Windows\rundll32.com
C:\Windows\rundll32.exe
C:\Windows\System32\rundll32
C:\Windows\System32\rundll32.bat
C:\Windows\System32\rundll32.com
C:\Windows\System32\rundll32.exe
rundll32 example.dll
rundll32 example.dll.bat
rundll32 example.dll.com
rundll32 example.dll.exe
C:\Windows\rundll32 example.dll
\end{verbatim}
et cetera.

Finally, common prefixes are eliminated. If after the first part of resolution,
the target is to Windows' \verb|rundll32.exe|, that part of the path is
stripped, the entire path after the first \verb|,| is stripped from the path,
and resolution is \textit{restarted} on the new argument. That is, this:
\begin{verbatim}
rundll32 baddie.dll,EntryPoint
\end{verbatim}
is (typically) resolved to
\begin{verbatim}
C:\Windows\System32\rundll32.exe
\end{verbatim}
which is Windows' Rundll32.exe. Therefore, this is stripped from the path, along
with everything after the first comma character, leaving:
\begin{verbatim}
Baddie.dll
\end{verbatim}
which may be (after resolution is re-run)
\begin{verbatim}
C:\Windows\baddie.dll
\end{verbatim}

\subsubsection{Default File Output} \label{stdfile}
Given a raw piece of data meant to represent a file, Instalog shall use the
following ``default file format'' where indicated.

If the file exists and company information (using Windows' version info
querying functions such as \verb|VerQueryValue|):
\begin{verbatim}
${ResolvedFile} [${Size} ${CreatedDate} ${Company}]
\end{verbatim}
where \var{ResolvedFile} is the raw data of the entry after going through
\textit{Path Resolution} (detailed in section \ref{pathresolution}), \var{Size}
is the size of the file in bytes, \var{CreatedDate} is the date the filesystem
has recorded as the file's creation date in the default date format (see
section \ref{stddate}), and \var{Company} is the company reported as the
file's author, using the general escaping format defined in \ref{generalescape}
with an escape character of hash (\verb|#|) and a right delimiter of right
square brace (\verb|]|).

If no company info is available, the format shall match:
\begin{verbatim}
${ResolvedFile} [${Size} ${CreatedDate}]
\end{verbatim}
using the same values as above.

If the file does not exist (and therefore resolution fails), the output shall
match:
\begin{verbatim}
${RawData} [x]
\end{verbatim}
where \var{RawData} is the information retrieved for the file, escaped using the
general escaping method, using an escape character of hash (\verb|#|).

Finally, if some failure occurred in path resolution that was not the file not
existing, then the output shall match the following:
\begin{verbatim}
${RawData} [?]
\end{verbatim}
(Where \var{RawData} is the same as above)

\subsubsection{Attributes} \label{attributes}
An attributes string is a string representation of the attribute flags on a file
as reported by the filesystem. An attributes string is 8 characters wide. It is
of the form: ``\verb|dcshatwr|''.

For the character \verb|w|, in the above, \verb|w| is used if the file is not
read only, while the letter \verb|r| is used if the file is read only.

The other characters are similar to boolean flags. If the specified attribute is
set, then the character appears. If it is not, \verb|-| is output instead. The
letters correspond to the following flags:
\begin{description}
\item[d] \verb|FILE_ATTRIBUTE_DIRECTORY|
\item[c] \verb|FILE_ATTRIBUTE_COMPRESSED|
\item[s] \verb|FILE_ATTRIBUTE_SYSTEM|
\item[h] \verb|FILE_ATTRIBUTE_HIDDEN|
\item[a] \verb|FILE_ATTRIBUTE_ARCHIVE|
\item[t] \verb|FILE_ATTRIBUTE_TEMPORARY|
\item[r] \verb|FILE_ATTRIBUTE_REPARSE_POINT|
\end{description}

\subsubsection{File Listing Format} \label{filelisting}
File Listing Format shall be defined as
\begin{verbatim}
${CDate} . ${MDate} ${Size} ${Attributes} ${Filepath}
\end{verbatim}
where \var{CDate} and \var{MDate} are the creation and modification dates of the
file, \var{Size} is the size of the file in bytes, right aligned and space
padded to 12 spaces wide, \var{Attributes} is an attributes string for the file
(see section \ref{attributes}), and \var{Filepath} is the path to the file in
question.

\subsection{File Formats}
This section describes on-disk formats that are used by Instalog.

\subsubsection{Executable} \label{executables}
Instalog shall detect whether a file is an executable by checking the first two
bytes of the file to see if they match ``\verb|MZ|'' (\verb|0x4D| \verb|0x5A|),
which is always the first two bytes of executables Windows is capable of
loading.